#!/bin/bash -xe

{{ if eq .chezmoi.osRelease.id "arch" }}
sudo pacman -Sy

# setup aur helper
if ! which pikaur >/dev/null; then
    git clone --depth 1 https://aur.archlinux.org/pikaur.git /tmp/pikaur
    cd /tmp/pikaur
    makepkg -si --noconfirm
    rm -rf /tmp/pikaur
fi

pikaur -S --needed --noconfirm {{ .packages.arch.base | join " " }}

{{ if ne .chassisType "container" }}
pikaur -S --needed --noconfirm {{ .packages.arch.base_desktop | join " " }}
{{ end }}

{{ else if eq .chezmoi.osRelease.id "fedora" }}
# setup extra repos
sudo dnf install dnf5-plugins
{{ range $r := .packages.fedora.repo }}
sudo dnf -y config-manager addrepo --overwrite --from-repofile {{ $r }}
{{ end }}
# RPMFusion
sudo dnf -y install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
sudo dnf -y config-manager setopt fedora-cisco-openh264.enabled=1
sudo dnf -y update

sudo dnf -y install {{ .packages.fedora.base | join " " }}

{{ if ne .chassisType "container" }}
sudo dnf -y install {{ .packages.fedora.base_desktop | join " " }}

# swaylock-plugins
if ! which swaylock-plugin &>/dev/null; then
    sudo dnf -y install meson wayland-devel wayland-protocols-devel libxkbcommon-devel cairo-devel gdk-pixbuf2-devel pam-devel scdoc
    git clone --depth 1 https://github.com/mstoeckl/swaylock-plugin.git /tmp/swaylock-plugin
    pushd /tmp/swaylock-plugin
    meson build
    ninja -C build
    sudo ninja -C build install
    sudo cp pam/swaylock-plugin /etc/pam.d/swaylock-plugin
    popd
fi

# linux-wallpaperengine
if ! which linux-wallpaperengine &>/dev/null; then
    sudo dnf -y install gcc g++ cmake libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel mesa-libGL-devel glew-devel freeglut-devel SDL2-devel lz4-devel ffmpeg-free ffmpeg-free-devel libXxf86vm-devel glm-devel glfw-devel mpv mpv-devel pulseaudio-libs-devel fftw-devel gmp-devel kiss-fft
    git clone --depth 1 --recurse-submodules  https://github.com/Almamu/linux-wallpaperengine.git /tmp/linux-wallpaperengine
    pushd /tmp/linux-wallpaperengine
    mkdir build && cd build
    cmake -DCMAKE_BUILD_TYPE='Release' ..
    make
    sudo mv output/ /opt/linux-wallpaperengine
    popd
fi
{{ end }}

if [[ ! -d "$HOME/.pyenv" ]] then
    curl -fsSL https://pyenv.run | bash
fi
if ! which pay-respects &>/dev/null; then
    curl -sSfL https://raw.githubusercontent.com/iffse/pay-respects/main/install.sh | sh
fi
if ! which starship &>/dev/null; then
    curl -sS https://starship.rs/install.sh | sh
fi
#if ! dnf info msttcore-fonts-installer.noarch &>/dev/null; then
#    # https://mscorefonts2.sourceforge.net/
#    sudo dnf -y curl cabextract xorg-x11-font-utils fontconfig
#    sudo rpm -i https://downloads.sourceforge.net/project/mscorefonts2/rpms/msttcore-fonts-installer-2.6-1.noarch.rpm
#fi
if lpf state 2>/dev/null | grep -q approve-wait; then
    lpf update
fi
{{ end }}

# on arch, we install autotiling via pacman
# on other distros, we install via pip
{{ if ne .chezmoi.osRelease.id "arch" }}
pip install --user autotiling
{{ end }}

# other loose packages
go install github.com/badjware/gitforgefs@latest

if ! which mirrord &>/dev/null; then
    bash ~/.cache/install/mirrord.sh
fi

{{ if ne .chassisType "container" }}
if [[ ! -d "$HOME/.themes/Orchis" ]]; then
    git clone --depth 1 https://github.com/vinceliuice/Orchis-theme.git /tmp/orchis
    pushd /tmp/orchis
    ./install.sh
    popd
    rm -rf /tmp/orchis
fi

if [[ ! -d "$HOME/.local/share/icons/Tela-circle" ]]; then
    git clone --depth 1 https://github.com/vinceliuice/Tela-circle-icon-theme.git /tmp/tela-circle
    pushd /tmp/tela-circle
    ./install.sh -n Tela-circle
    popd
    rm -rf /tmp/tela-circle
fi
{{ end }}