#!/bin/bash -x

swaylock=swaylock
swaylock_args=

# check if battery is discharging
battery_status=$(cat /sys/class/power_supply/BAT*/status 2>/dev/null | grep -vq "Discharging")

# select screen
screens="$(swaymsg -t get_outputs | jq -r '.[] | select(.transform=="normal") | .name' | tr '\n' ' ')"

if [[ -z "$battery_status" || -z "$screens" ]] then
    if which swaylock-plugin &>/dev/null; then
        # check if wallpaper engine is installed
        wallpaper_dir="$(find ~/.steam/steam/steamapps/workshop/content/431960 ~/.local/share/Steam/steamapps/workshop/content/431960 ~/.var/app/com.valvesoftware.Steam/.local/share/Steam/steamapps/workshop/content/431960 ~/snap/steam/common/.local/share/Steam/steamapps/workshop/content/431960 -mindepth 1 -maxdepth 1 -name "$WALLPAPERENGINE_STEAM_WORKSHOP_ID" | head -n 1)"
        if which mpvpaper &>/dev/null && [ -e "$MPVPAPER_VIDEO_PATH" ]; then
            swaylock=swaylock-plugin
            swaylock_command="mpvpaper --mpv-option 'no-audio loop $MPVPAPER_OPTION --quiet' $screen -- $MPVPAPER_VIDEO_PATH"
            swaylock_args=(--grace 5sec --command "$swaylock_command")
        elif which linux-wallpaperengine &>/dev/null && [ -n "$wallpaper_dir" ]; then
            swaylock=swaylock-plugin
            swaylock_command="linux-wallpaperengine --screen-root $screen --silent --no-fullscreen-pause --disable-mouse $WALLPAPERENGINE_EXTRA_ARGS $WALLPAPERENGINE_STEAM_WORKSHOP_ID"
            swaylock_args=(--grace 5sec --command "$swaylock_command")
        fi
    fi
fi

if [[ -n "$swaylock_args" ]]; then
    $swaylock $@ "${swaylock_args[@]}"
else
    $swaylock $@
fi
