#!/bin/bash -x

# check if battery is discharging
battery_status=$(cat /sys/class/power_supply/BAT*/status 2>/dev/null | grep -vq "Discharging")

# select screen
screens="$(swaymsg -t get_outputs | jq -r '.[] | select(.active==true) | .name' | tr '\n' ' ')"

if [[ -z "$battery_status" || -z "$screens" ]] then
    if which swaylock-plugin &>/dev/null; then
        # check if wallpaper engine is installed
        wallpaper_dir="$(find ~/.steam/steam/steamapps/workshop/content/431960 ~/.local/share/Steam/steamapps/workshop/content/431960 ~/.var/app/com.valvesoftware.Steam/.local/share/Steam/steamapps/workshop/content/431960 ~/snap/steam/common/.local/share/Steam/steamapps/workshop/content/431960 -mindepth 1 -maxdepth 1 -name "$WALLPAPERENGINE_STEAM_WORKSHOP_ID" | head -n 1)"
        
        if which mpvpaper &>/dev/null && [ -e "$MPVPAPER_VIDEO_PATH" ]; then
            swaylock_command="mpvpaper --mpv-option 'no-audio loop $MPVPAPER_OPTION --quiet --panscan=1' $screens -- $MPVPAPER_VIDEO_PATH"
        elif which linux-wallpaperengine &>/dev/null && [ -n "$wallpaper_dir" ]; then
            swaylock_command="linux-wallpaperengine"
            for s in $screens; do
                swaylock_command+=" --screen-root $s"
            done
            swaylock_command+=" --silent --no-fullscreen-pause --disable-mouse --scaling=fill $WALLPAPERENGINE_EXTRA_ARGS $WALLPAPERENGINE_STEAM_WORKSHOP_ID"
        fi
    fi
fi

if [[ -n "$swaylock_command" ]]; then
    exec swaylock-plugin $@ --command "$swaylock_command" -d
else
    exec swaylock $@
fi
