#!/bin/bash

wg_config="wg0.conf"

print_help() {
	echo ""
	echo "Connect to a wireguard vpn from a configuration stored in TOMB"
	echo ""
	echo "Usage:   tomb-wg [options] tomb_file operation"
	echo ""
	echo "Options:"
	echo "   -h, --help         print this help text"
	echo "   -k, --key          the TOMB key file"
	echo "   -c, --config       the name of the wireguard config file in the TOMB (default: $wg_config)"
	echo ""
}

short_args=hk:c:
long_args=help,key:,config:

# parse arguments
parsed_args=$(getopt --options $short_args --longoptions $long_args --name "$0" -- "$@")

parsed_args=$(getopt --options $short_args --longoptions $long_args --name "$0" -- "$@")
if [[ $? -ne 0 ]]; then
	echo "Failed to parse arguments"
	exit 2
fi
eval set -- "$parsed_args"
while true; do
	case "$1" in
		-h|--help)
			print_help
	        exit 0
			;;
		-k|--key)
            tomb_key="$2"
			shift 2
			;;
		-c|--config)
            wg_config="$2"
			shift 2
			;;
		--)
			shift
            break
            ;;
		*)
			break
            ;;
    esac
done

tomb_file="$1"
op="$2"

if [[ -z "$tomb_key" ]]; then
    echo 'Missing required argument "-k tomb_key"'
    print_help
    exit 1
fi

if [[ -z "$tomb_file" ]]; then
    echo 'Missing required argument "tomb_file"'
    print_help
    exit 1
fi

if [[ -z "$tomb_file" ]]; then
    echo 'Missing required argument "operation"'
    print_help
    exit 1
elif [[ "$op" != "up" && "$op" != "down" ]]; then
	echo "Invalid operation: $op (must be \"up\" or \"down\")"
	exit 1
fi

mountpoint="$(mktemp -d)"

tomb open -k "$tomb_key" "$tomb_file" "$mountpoint"
tomb index -q "$tomb_file"
tomb search -q "$wg_config" | head -n 1 | xargs wg-quick "$op"
tomb close "$tomb_file"
rmdir "$mountpoint"