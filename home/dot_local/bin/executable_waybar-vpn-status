#!/usr/bin/env bash

vpn_state_file="$XDG_RUNTIME_DIR/vpn_state"
vpn_state="$(cat "$vpn_state_file")"
vpn_cidr="$(ip addr show dev tun0 2>/dev/null | grep -Eo '([0-2]*[0-9]*[0-9]\.){3}([0-2]*[0-9]*[0-9])/[0-9]+')"

if [[ -n "$vpn_cidr" ]]; then
  text="󰴴"
  tooltip="$vpn_cidr"
  class="vpn"
  state="connected"
else
  text="󰦜"
  tooltip="VPN Disconnected"
  class="vpn"
  state="disconnected"
fi

if [[ "$vpn_state" != "$state" ]]; then
  notify-send -t 5000 "VPN Status Changed" "VPN $state"
  echo "$state" > "$vpn_state_file"
fi

jq -c -n --arg text "$text" --arg tooltip "$tooltip" --arg class "$class" \
    '{text: $text, tooltip: $tooltip, class: $class}'