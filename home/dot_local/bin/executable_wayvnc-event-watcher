#!/bin/bash

WAYVNCCTL=${WAYVNCCTL:-wayvncctl}

on-client-change() {
    # if [[ $1 -eq 1 ]]; then
    #     on-remote-client-connect
    # elif [[ $1 -eq 0 ]]; then
    #     on-remote-client-disconnect
    # fi
    if [[ $1 -eq 0 ]]; then
        echo "No more clients, stopping wayvnc"
        # cleanup the outputs
        on-remote-client-disconnect
        # stop the vnc server
        "$WAYVNCCTL" wayvnc-exit
    fi
}

while IFS= read -r EVT; do
    echo "Got event $EVT"
    case "$(jq -r '.method' <<<"$EVT")" in
        client-*onnected)
            count=$(jq -r '.params.connection_count' <<<"$EVT")
            echo "Total clients: $count"
            on-client-change "$count"
            ;;
        wayvnc-shutdown)
            echo "wayvncctl is no longer running"
            exit
            ;;
        wayvnc-startup)
            echo "Ready to receive wayvnc events"
            ;;
    esac
done < <("$WAYVNCCTL" --wait --reconnect --json event-receive)